<?php

/**
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2017 OA Wu Design
 * @license     http://creativecommons.org/licenses/by-nc/2.0/tw/
 * @link        https://www.ioa.tw/
 */

include_once 'libs' . DIRECTORY_SEPARATOR . 'Define.php';
include_once 'libs' . DIRECTORY_SEPARATOR . 'Func' . PHP;
include_once 'libs' . DIRECTORY_SEPARATOR . 'Logger' . PHP;
include_once 'libs' . DIRECTORY_SEPARATOR . 'Minify' . PHP;

use function color as cc;

$file = array_shift ($argv);

define ('FILENAME', str_replace (__DIR__ . DIRECTORY_SEPARATOR, '', __FILE__));

if (!function_exists ('uploadHeaderText')) {
  function uploadHeaderText () {
    system ('clear');
    echo cc (str_repeat ('â•', CLI_LEN)) . "\n\n";
    echo " ã€ " . cc ('æ­¡è¿ä½¿ç”¨ OAF2E å€‹äººå·¥å…·', 'y') . " ã€‘" . str_repeat (' ', CLI_LEN - 48) . cc ('v 1.0', 'N') . '    ' . cc ('by', 'N') . ' ' . cc ('OA Wu', 'W') . "\n\n";
    echo cc (str_repeat ('â•', CLI_LEN)) . "\n\n";
  }
}

if (!function_exists ('removeRoot')) {
  function removeRoot () {
    if (!(file_exists (PATH_CMD . 'root') && !@unlink (PATH_CMD . 'root')))
      return;
    echo cc ('å¤±æ•—', 'r') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";
    exit();
  }
}

if (!function_exists ('minifyStatic')) {
  function minifyStatic () {
    if (file_exists ('_dirs' . PHP))
      include_once '_dirs' . PHP;

    if (isset ($_dirs))
      foreach ($_dirs as $key => $dir) {
        $fs = array ();
        mergeArrRec (mapDir ($p = PATH . trim ($key, DIRECTORY_SEPARATOR), (isset ($dir[1]) ? $dir[1] : true) ? 0 : 1, isset ($dir[2]) ? $dir[2] : false, isset ($dir[0]) ? $dir[0] : array ()), $fs, $p);

        foreach ($fs as $f) {
          $bom = pack ('H*','EFBBBF');

          switch (pathinfo ($f, PATHINFO_EXTENSION)) {
            case 'html': myWriteFile ($f, preg_replace ("/^$bom/", '', HTMLMin::minify (myReadFile ($f)))); break;
            case 'css': myWriteFile ($f, preg_replace ("/^$bom/", '', CSSMin::minify (myReadFile ($f)))); break;
            case 'js': myWriteFile ($f, preg_replace ("/^$bom/", '', JSMin::minify (myReadFile ($f)))); break;
          }
        }
      }
  }
}
if (!function_exists ('acc')) {
  function listGit (&$hasGhPages, &$nowBranch) {
    exec ('git branch', $shellOutput);
    $hasGhPages = in_array ('gh-pages', array_map ('trim', $shellOutput));
    (($nowBranch = array_values (array_map (function ($branch) { return preg_replace ('/^\* /', '', $branch); }, array_filter (array_map ('trim', $shellOutput), function ($branch) { return preg_match ('/^\* /', $branch); })))) && $nowBranch = $nowBranch[0]) || $nowBranch = 'master';
  }
}
if (!function_exists ('acc')) {
  function acc () {
    exec ('git remote get-url origin', $shellOutput);
    ($shellOutput = array_map ('trim', $shellOutput)) && $shellOutput = $shellOutput[0];
    if (!$shellOutput)
      return null;
    if (preg_match_all ('/git@github\.com:(?<match>.*)\/.*/', $shellOutput, $matches))
      return isset ($matches['match'][0]) ? $matches['match'][0] : null;
    if (preg_match_all ('/https:\/\/github\.com\/(?<match>.*)\/.*/', $shellOutput, $matches))
      return isset ($matches['match'][0]) ? $matches['match'][0] : null;
    return null;
  }
}

if (!function_exists ('noAnyModify')) {
  function noAnyModify () {
    exec ('git status -s', $shellOutput);
    ($shellOutput = array_map ('trim', $shellOutput)) && $shellOutput = $shellOutput[0];
    if (!$shellOutput)
      return true;

    return false;
  }
}

if (!noAnyModify()) {
  system ("clear");
  echo cc ('â•”' . str_repeat ('â•', CLI_LEN - 2) . 'â•—', 'W', 'r') . "\n";
  echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•‘' . ' ', 'W', 'r') . cc ('è­¦å‘Šï¼', 'Y', 'r') . cc ('æ‚¨å°šæœªé‡å°å°ˆæ¡ˆåš Commit å–”ï¼' . str_repeat(' ', CLI_LEN - 37) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•š' . str_repeat ('â•', CLI_LEN - 2) . 'â•', 'W', 'r') . "\n";
  echo "\n";
  echo ' ' . cc ('â€»', 'r') . " ç‚ºäº†é é˜²è¬ä¸€ï¼Œéƒ¨ç½²ä¹‹å‰è«‹å…ˆ Commitï¼Œæ–¹æ³•å¦‚ä¸‹å…©ç¨®ï¼š" . "\n" . '                 ' . cc ('â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾', 'N');
  echo "\n";
  echo '   ' . cc ('1.', 'N') . " è«‹ä½¿ç”¨ Git ç®¡ç†å·¥å…·(å¦‚ " . cc ('Source', 'B') . ")ï¼ŒåŸ·è¡Œ Commit\n";
  echo "                             " . cc ('^^^^^^', 'R') . "\n";
  echo '   ' . cc ('2.', 'N') . " ä½¿ç”¨æŒ‡ä»¤ " . cc (' git add -A && git commit -m "è¨»è§£" ', 'W', 'r') . "\n";
  echo "               " . cc ('^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^', 'R') . "\n";
  echo ' ' . cc ('â€»', 'r') . " å¦‚å¤±æ•—æˆ–ä¸è§£ï¼Œè«‹è¯çµ¡ä½œè€… " . cc ('OA Wu', 'W') . cc (' https://www.ioa.tw/', 'w') . ' å§ï¼' . "\n" . '                                  ' . cc ('â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾', 'N');
  echo "\n";
  exit();
}
if (!file_exists (PATH_CMD . 'node_modules' . DIRECTORY_SEPARATOR . 'gulp'. DIRECTORY_SEPARATOR . 'bin' . DIRECTORY_SEPARATOR . 'gulp.js')) {
  system ("clear");
  echo cc ('â•”' . str_repeat ('â•', CLI_LEN - 2) . 'â•—', 'W', 'r') . "\n";
  echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•‘' . ' ', 'W', 'r') . cc ('è­¦å‘Šï¼', 'Y', 'r') . cc ('æ‚¨å°šæœªåˆå§‹åŒ–é–‹ç™¼ç’°å¢ƒå–”ï¼' . str_repeat(' ', CLI_LEN - 33) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'W', 'r') . "\n";
  echo cc ('â•š' . str_repeat ('â•', CLI_LEN - 2) . 'â•', 'W', 'r') . "\n";
  echo "\n";
  echo ' ' . cc ('â€»', 'r') . " è«‹å…ˆåŸ·è¡Œ " . cc (' npm install . ', 'W', 'r') . ' å¾Œå†ä¾†åŸ·è¡Œæœ¬ç¨‹å¼å§ï¼' . "\n";
  echo "            " . cc ('^^^^^^^^^^^^^^^', 'R') . "\n";
  echo ' ' . cc ('â€»', 'r') . " è‹¥æ˜¯å¤±æ•—çš„è©±å¯ä»¥æ”¹æ›åŸ·è¡Œ " . cc (' sudo npm install . ', 'W', 'r') . " è©¦è©¦å§ï¼\n";
  echo "                            " . cc ('^^^^^^^^^^^^^^^^^^^^', 'R') . "\n";
  echo ' ' . cc ('â€»', 'r') . " å¦‚æœéƒ½å¤±æ•—çš„è©±ï¼Œè«‹ç¢ºèªæ‚¨æ˜¯å¦æœ‰å®‰è£ Node.js èˆ‡ Gulp" . "\n";
  echo "\n";
  echo ' ' . cc ('â€»', 'r') . " è©¦è‘—è¯çµ¡ä½œè€… " . cc ('OA Wu', 'W') . cc (' https://www.ioa.tw/', 'w') . ' å§ï¼' . "\n" . '                      ' . cc ('â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾', 'N');
  echo "\n";
  exit();
}

if (!$argv) {
  uploadHeaderText ();
  do {
    uploadHeaderText ();
    echo ' ' . cc ('â€»', 'r') . " é¸å–®\n";
    echo ' ' . cc (str_repeat ('â•', 6), 'N') . "\n";
    echo '   ' . cc ('1.', 'W') . ' ' . 'éƒ¨ç½²åˆ° GitHub gh-pages Demo ' . "\n";
    echo '   ' . cc ('2.', 'W') . ' ' . 'éƒ¨ç½²åˆ° Amazon Web Services S3 ' . "\n";
    echo '   ' . cc ('q.', 'W') . ' ' . 'æ²’äº‹ï¼ŒæŒ‰éŒ¯.. ' . "\n";
    echo "\n";
    echo ' ' . cc ('âœ', 'G') . ' è«‹å•ä½ è¦å¹¹å˜›ï¼Ÿ' . cc ('(q)', 'N') . 'ï¼š';

    ($cho = trim (fgets (STDIN))) || $cho = 'q';
  } while (!in_array (strtolower ($cho), array ('1', '2', 'q')));

  
  if ($cho == '1')
    cho1 ('step1');
  
  if ($cho == '2')
    cho2 ('all');
  
  if ($cho == 'q')
    echo "\n";
    echo ' ' . cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";
    echo "  ğŸ˜Š  å¥½çš„ï¼ä¸‹æ¬¡åˆ¥å†æŒ‰éŒ¯å›‰ï¼ŒæœŸå¾…æ‚¨ä¸‹æ¬¡å†ä½¿ç”¨ï¼ŒğŸ‘‹  " . cc ('æ°æ°', 'W') . "ï½  \n\n";
    echo ' ' . cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";

} else {
  if (count ($argv) < 2)
    exit;

  if (!is_callable ($func = array_shift ($argv)))
    exit;

  call_user_func_array ($func, $argv);
}

function cho2 ($argv = null) {
  $cmds = array ();
  if ($argv == 'all') {

    include_once 'demo.php';
    echo cc (str_repeat ('â•', CLI_LEN)) . "\n";
    echo ' ' . cc ('â—', 'G') . " åˆ‡å›åŸæœ¬åˆ†æ”¯ - ";
      ($cmd = 'git checkout .. --quiet') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n";
    echo cc (str_repeat ('â•', CLI_LEN)) . "\n\n";
  }
}
function cho1 ($argv = null, $nowBranch = 'master') {
  if ($argv == 'step1') {
    system ("clear");
    echo cc (str_repeat ('â•', CLI_LEN)) . "\n" . ' ' . cc ('â— éƒ¨ç½²é–‹å§‹ â—', 'P') . "\n" . cc (str_repeat ('â•', CLI_LEN)) . "\n";
    
    echo ' ' . cc ('â—', 'G') . " æƒæ Git è¨Šæ¯ - ";
      listGit ($hasGhPages, $nowBranch);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " ç§»é™¤æœ¬åœ°ç«¯ gh-pages åˆ†æ”¯ - ";
      ($cmd = $hasGhPages ? 'git branch -D gh-pages' : '') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";
    
    echo ' ' . cc ('â—', 'G') . " å»ºç«‹æœ¬åœ°ç«¯ gh-pages åˆ†æ”¯ - ";
      ($cmd = 'git branch -v gh-pages') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";
    
    echo ' ' . cc ('â—', 'G') . " åˆ‡æ›è‡³ gh-pages åˆ†æ”¯ - ";
      ($cmd = 'git checkout gh-pages --quiet') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " ç§»é™¤ä¸å¿…è¦æª”æ¡ˆ - ";
      removeRoot ();
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " å£“ç¸®éœæ…‹æª”æ¡ˆ - ";
      minifyStatic ();
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " ç´€éŒ„ Commit - ";
      ($cmd = 'git add -A && git commit -m "å£“ç¸®éœæ…‹æª”æ¡ˆ(js, html, css)ã€ç§»é™¤ä¸å¿…è¦æª”æ¡ˆã€‚" --quiet') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " ä¸Šå‚³ push - ";
      ($cmd = 'git push origin gh-pages --force --quiet') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n" . cc (str_repeat ('â”€', CLI_LEN), "N") . "\n";

    echo ' ' . cc ('â—', 'G') . " åˆ‡å›åŸæœ¬åˆ†æ”¯ - ";
      ($cmd = 'git checkout ' . $nowBranch . ' --quiet') && exec ($cmd, $shellOutput);
    echo cc ('å®Œæˆ', 'g') . "\n";
    
    echo cc (str_repeat ('â•', CLI_LEN), "N") . "\n" . ' ' . cc ('â— ğŸ‰  å®Œæˆéƒ¨ç½² ğŸº  â—', 'P') . "\n" . cc (str_repeat ('â•', CLI_LEN), "N") . "\n\n";
    
    echo ' ' . cc ('âœ', 'R') . ' ' . cc ('æ‚¨çš„ç¶²å€æ˜¯', 'G') . 'ï¼š' . (($acc = acc ()) ? 'https://' . $acc . '.github.io/' . FNAME . '/' . (file_exists (PATH . 'index.html') ? 'index.html' : '') : '');
    echo "\n\n";

  }

  exit;
}
